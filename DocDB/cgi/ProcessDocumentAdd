#! /usr/bin/env perl
#
# Author Eric Vaandering (ewv@fnal.gov)
#

use Benchmark;
use CGI;
use DBI;

$StartTime = new Benchmark;

require "DocDBGlobals.pm";
require "ResponseElements.pm";
require "AuthorSQL.pm";
require "TopicSQL.pm";
require "SecuritySQL.pm";
require "DocumentSQL.pm";
require "RevisionSQL.pm";
require "MiscSQL.pm";
require "FSUtilities.pm";
require "WebUtilities.pm";
require "HTMLUtilities.pm";
require "Security.pm";

if ($MailInstalled) {
  require "MailNotification.pm";
}

$query = new CGI;  # Global for subroutines
$dbh   = DBI->connect('DBI:mysql:'.$db_name.':'.$db_host,$db_rwuser,$db_rwpass);

&GetTopics; 
&GetJournals;
&GetSecurityGroups; 

### Set up, give user initial information

%params = $query -> Vars;
$mode = $params{mode};

print $query->header;
if ($mode eq "reserve") {
  &DocDBHeader("$Project Document Reservation Results","Document Reservation Results"); 
} elsif ($mode eq "add") {
  &DocDBHeader("$Project Document Addition Results","Document Addition Results"); 
} elsif ($mode eq "update" || $mode eq "updatedb") {
  &DocDBHeader("$Project Document Modification Results","Document Modification Results"); 
}

### Pull info out of params into local variables
### FIXME: Get all the params here, too confusing later on to be using $param

@ErrorStack = ();
@WarnStack  = ();

$Special = $params{special};

if ($Special eq "meeting") {$Meeting = 1;}
if ($Special eq "othermeeting") {$OtherMeeting = 1;}

$Archive    = $params{archive};
$Overdate   = $params{overdate};
$Overday    = $params{overday};
$Overmonth  = $params{overmonth};
$Overyear   = $params{overyear};
$Overmin    = $params{overmin};
$Overhour   = $params{overhour};
@JournalIDs = split /\0/,$params{journal};
@Volumes    = split /\0/,$params{volume};
@Pages      = split /\0/,$params{page};
$Keywords   = $params{keywords};
$Requester  = $params{requester};

if ($Meeting || $OtherMeeting) {
  @authorIDs = ($Requester);
} else {
  if ($params{authormanual}) {
    @authorIDs = &ProcessManualAuthors($params{authormanual});
  } else {
    @authorIDs = split ("\0",$params{authors}); 
  }
}

if ($Archive eq "multi") {$Archive = "single";} # No real difference

if ($Overdate && $Overyear && $Overmonth && $Overday) {
  $SQL_NOW = "$Overyear-$ReverseAbrvMonth{$Overmonth}-$Overday $Overhour:$Overmin:00";
} else {
  my ($sec,$min,$hour,$day,$mon,$year) = localtime(time); 
  $year += 1900;
  ++$mon;
  $SQL_NOW = "$year-$mon-$day $hour:$min:$sec";
}  

if ($mode ne "add"    && $mode ne "reserve" && 
    $mode ne "update" && $mode ne "updatedb") {
  &EndPage("<p><h3>You accessed this page without 
            specifying a required parameter. 
            Don't manipulate hidden fields or 
            try to access this page directly. Mode is $mode.</h3>\n"); 
}  

if      ($mode eq "add") {
  print "<p><h3>Here are the results of your attempt to add a document
                into the $Project document database:</h3><p>\n";
} elsif ($mode eq "reserve") {              
  print "<p><h3>Here are the results of your attempt to reserve a document
                number in the $Project document database:</h3><p>\n";
} elsif ($mode eq "update" || $mode eq "updatedb") {              
  print "<p><h3>Here are the results of your attempt to update a document
                in the $Project document database:</h3><p>\n";
}

### Database insert templates

my $document_insert = $dbh->prepare(
   "insert into Document ".
          "(DocumentID, RequesterID, RequestDate, DocumentType) ". 
   "values (0,          ?,           ?,           ?)");
            
my $doc_rev_insert = $dbh->prepare(
   "insert into DocumentRevision ".
   "(DocRevID, DocumentID, SubmitterID, DocumentTitle, PublicationInfo, ". 
   " VersionNumber, Abstract, RevisionDate,Keywords) ". 
   "values (0,?,?,?,?,?,?,?,?)");
            
my $rev_author_insert =  $dbh->prepare(
   "insert into RevisionAuthor ".
   "       (RevAuthorID, DocRevID, AuthorID) ".
   "values (0,           ?,        ?)");
                                 
my $rev_security_insert =  $dbh->prepare(
   "insert into RevisionSecurity ".
   "       (RevSecurityID, DocRevID, GroupID) ".
   "values (0,             ?,        ?)");

my $RevModifyInsert   =  $dbh->prepare(
   "insert into RevisionModify ".
   "       (RevModifyID, DocRevID, GroupID) ".
   "values (0,             ?,        ?)");
                                  
my $rev_topic_insert = $dbh->prepare(
   "insert into RevisionTopic ".
   "       (RevTopicID, DocRevID, MinorTopicID) ".
   "values (0,          ?,        ?)");

my $ReferenceInsert  = $dbh -> prepare(
     "insert into RevisionReference ".
     "       (ReferenceID,DocRevID,JournalID,Volume,Page)".
     "values (0,          ?,       ?,        ?,     ?)"); 

my $file_insert = $dbh->prepare(
   "insert into DocumentFile ".
   "       (DocFileID, DocRevID, FileName, Date, RootFile, Description) ".
   "values (0,         ?,        ?,        ?,    ?       , ?)");

# FIXME: Build links for other document actions to use below

### Check parameters for errors

unless (&CanCreate()) {
  push @ErrorStack,"You are not allowed to modify or create documents.";
}
unless ($params{requester}) {
  push @ErrorStack,"You must supply a requester for this document.";
}
unless ($params{title}) {
  push @ErrorStack,"You must supply a title for this document.";
}

if (@JournalIDs || @Volumes || @Pages) {
  my @TestJournalIDs = @JournalIDs;
  my @TestVolumes    = @Volumes;
  my @TestPages      = @Pages;
  foreach my $JournalID (@TestJournalIDs) {
    my $Volume = shift @TestVolumes;
    my $Page   = shift @TestPages;
    if (($JournalID || $Volume || $Page) && !($JournalID && ($Volume || $Page))) {
      push @ErrorStack,"Your reference $Journals{$JournalID}{Acronym}, vol. $Volume,
      pg. $Page must consist of a journal plus a volume, page number, or
      both.";
    }
  }
}    
    
if ($mode eq "add" || $mode eq "reserve") {
  unless ($params{doctype}) {
    push @ErrorStack,"You must supply a document type for this document.";
  }
}
if ($mode eq "add" || $mode eq "update") {
#  unless ($params{authors} || $params{authormanual}) {
#    push @ErrorStack,"You must supply at least one author for this document.";
#  }
  unless ($params{topics}) {
    push @ErrorStack,"You must supply at least one topic for this document.";
  }
  unless ($params{abstract}) {
    push @ErrorStack,"You must supply an abstract for this document.";
  }
  unless (grep /\w/,$params{single_upload} || grep /\w/,$params{single_http}) {
    push @ErrorStack,"You must supply a file for this document.";
    push @ErrorStack,"If you just want to change information about the
    document, choose `Update DB Info' instead.";
  }
  if     ($params{single_upload} && $params{single_http}) {
    push @ErrorStack,"You may not specify both URL and file upload.";
  }
  if     (!$params{mainfile} && $Archive eq "archive") {
    push @ErrorStack,"You must specify a main file in the archive.";
  }
  
  if ($params{single_http}) {
    if ($params{http_user} && $params{http_pass}) {
      $Authentication = " --http-user $params{http_user} --http-pass $params{http_pass} ";
    } else {
      $Authentication = "";
    }  
    my @urls = split /\0/,$params{single_http};
    foreach my $url (@urls) {
      if (&ValidFileURL($url)) {
        my $command = $Wget.$Authentication.$url;
        my @url_lines = `$command`;
        unless (@url_lines) {
          push @ErrorStack,"The URL <tt>$url</tt> was not present or was protected.";
        }
      } else {
        push @ErrorStack,"The URL <tt>$url</tt> is not well formed. Don't forget ".
                          "http:// on the front and a file name after the last /.";
      }
    }  
  }  
}

if ($mode eq "update" || $mode eq "updatedb") {
  unless ($params{docid}) {
    push @ErrorStack,"You must supply a document number to modify a document.";
  }
  unless (&CanModify($params{docid})) {
    push @ErrorStack,"You are not allowed to modify this document.";
  }
}

### Final checks

@topicIDs   = split ("\0",$params{topics});
@securities = split ("\0",$params{security});
if ($EnhancedSecurity) {
  @ModifyGroups = split ("\0",$params{modify});
}

if ($mode eq "add" || $mode eq "update" || $mode eq "updatedb") {
  unless (@authorIDs) {
    push @ErrorStack,"You must supply at least one author for this document.";
  }
}

if ($#securities > 0) {
  foreach my $GroupID (@securities) {
    if ($GroupID == 0) {
      push @ErrorStack,"You selected \"Public\" and another form of security. ".
                    "You may only select \"Public\" by itself.";
    }
  }  
}

if ($EnhancedSecurity) {
  unless (@ModifyGroups) {
    push @ErrorStack,"You must select at least one group which is allowed to 
                      modify the document.";
  }                    
}
  
&EndPage(@ErrorStack);

### Make entry in DocumentDatabase or get document ID

my $documentID;
if ($mode eq "reserve" || $mode eq "add") {
  $document_insert -> execute($params{requester},$SQL_NOW,$params{doctype});
  $documentID = $document_insert -> {mysql_insertid}; # Works with MySQL only
} else {
  $documentID = $params{docid};
}  

### Set version number. For reservations, it is "0", for new documents "1". For
### updates, increment by one, and for DB info updates, either the latest
### version or the one being updated

my $version;
if      ($mode eq "reserve") {
  $version   = 0;
} elsif ($mode eq "add") {
  $version   = 1;
} elsif ($mode eq "update") {
  &FetchDocument($documentID);
  $version   = $Documents{$documentID}{NVER} + 1;
} elsif ($mode eq "updatedb") {
  &FetchDocument($documentID);
  if  (defined $params{version}) {
    $version = $params{version};
  } else { 
    $version = $Documents{$documentID}{NVER};
  }
  if ($version != $Documents{$documentID}{NVER}) {
    push @WarnStack,"You have updated an old version of a document. Hope this
    is what you wanted to do.";
  }
}

if ($mode eq "updatedb") { # New Document revision replaces old. Fetch 
                           # old DocumentRevision and mark it obsolete
  my $OldRevID = &FetchRevisionByDocumentAndVersion($documentID,$version);
  my $obsolete_revision = $dbh -> prepare(
     "update DocumentRevision set Obsolete=1 where DocRevID=?");
  $obsolete_revision -> execute($OldRevID); 
}  

### Add entry to Document Revision

$doc_rev_insert -> execute($documentID,$params{requester},$params{title},
                           $params{pubinfo},$version,$params{abstract},
                           $SQL_NOW,$Keywords);
my $docRevID = $doc_rev_insert -> {mysql_insertid}; # Works with MySQL only

### Add reference information if it exists

if (@JournalIDs || @Volumes || @Pages) {
  foreach my $JournalID (@JournalIDs) {
    my $Volume = shift @Volumes;
    my $Page   = shift @Pages;
    if ($JournalID) { # Can delete references too.
      $ReferenceInsert -> execute($docRevID,$JournalID,$Volume,$Page);
    }  
  }
}    

### Add to authors, topics and securities
                           
foreach $authorID (@authorIDs) {
  $rev_author_insert -> execute($docRevID,$authorID);
}
foreach $topicID (@topicIDs) {
  $rev_topic_insert -> execute($docRevID,$topicID);
}
foreach $securityID (@securities) {
  if ($securityID) {  # Skip "0/Public" 
    $rev_security_insert -> execute($docRevID,$securityID);
  }  
}

if ($EnhancedSecurity) {
  foreach my $GroupID (@ModifyGroups) {
    if ($GroupID) {  # Skip "0/Public" (shouldn't happen) 
      $RevModifyInsert -> execute($docRevID,$GroupID);
    }  
  }
}

### Deal with files

if ($mode eq "updatedb") { # Copy DocumentFile entries
  &ProtectDirectory($documentID,$version,@securities); # Redo security 
 
  my ($FileName,$Date,$RootFile,$Description);

  my @FileIDs      = split ("\0",$params{fileid});
  my @Descriptions = split ("\0",$params{filedesc});
  my @Roots        = split ("\0",$params{root});

  my $file_list = $dbh->prepare(
    "select FileName,Date from DocumentFile where DocFileID=?");

  foreach my $FileID (@FileIDs) {
    $file_list -> execute($FileID);
    ($FileName,$Date) = $file_list -> fetchrow_array;
    $Description = shift @Descriptions; 
    $RootFile = 0;
    foreach my $Root (@Roots) {
      if ($Root == $FileID) { 
        $RootFile = 1;
      }
    }
    $file_insert -> execute($docRevID,$FileName,$Date,$RootFile,$Description);
  }  
}  

if ($mode eq "add" || $mode eq "update") { # We're adding new files
  
  $new_dir = &MakeDirectory($documentID,$version);
  &ProtectDirectory($documentID,$version,@securities);
  @short_files = ();
  if ($Archive eq "single") { # The user uploaded the files themselves 
    @Descriptions = split ("\0",$params{filedesc});
    @Roots = ();
    my @RawRoots = split ("\0",$params{root});
    foreach my $RawRoot (@RawRoots) {  # Simulate what I thought was happening
      @Roots[$RawRoot-1] = "on"
    }  
    if ($params{single_upload}) { # Copy file to directory
      @long_files   = $query ->  param("single_upload");
      foreach $long_file (@long_files) {
        if ($long_file) {
#          print "Adding file $long_file<br>\n"; # FIXME: Maybe useful with NPH
          $short_file = &ProcessUpload($new_dir,$long_file);
        } else {
          $short_file = "";
        }    
        push @short_files,$short_file;
      }
    } elsif ($params{single_http}) {
      @urls = split /\0/,$params{single_http};
      foreach $url (@urls) {
#        print "Adding URL $url<br>\n"; # FIXME: Maybe useful with NPH
        $short_file = &ProcessURL($new_dir,$url);
        push @short_files,$short_file;
      }  
    }
  } elsif ($Archive eq "archive") { # They uploaded a tar/zip file
    @short_files = ();
    @Descriptions = ();
    @Roots = ();
    if ($params{single_upload}) { # Copy tar file to directory
      $long_file = $query ->  param("single_upload"); # There can be only one
      $short_file = &ProcessUpload($new_dir,$long_file);
      &ProcessArchive($new_dir,$short_file);
    } elsif ($params{single_http}) {
      $url = $params{single_http};  # There can be only one
      $short_file = &ProcessURL($new_dir,$url);
      &ProcessArchive($new_dir,$short_file);
    } 
  } # Archive upload

### Insert into Files database

  foreach $short_file (@short_files) {
    $Description = shift @Descriptions;
    $rootfile = shift @Roots;
    if ($rootfile eq "on") {
      $rootfile = 1;
    } else {
      $rootfile = 0;
    }  
    if ($short_file) {  
      $file_insert -> execute($docRevID,$short_file,$SQL_NOW,$rootfile,$Description);
    }
  }
} # File upload for "add" and "update"

### If we had any warnings print them out now

&WarnPage(@WarnStack);
@WarnStack = ();
  
if ($mode = "updatedb") { # Local DB not in sync, clear it
  %DocRevIDs    = ();
  %DocRevisions = ();
  %Documents    = ();
  @DocumentIDs  = ();
}

# Output feedback to the user

$full_docid  = &FullDocumentID($documentID);
my $DocRevID = &FetchRevisionByDocumentAndVersion($documentID,$version);

unless ($DocRevID) {
  print "This document does not exist.<p>\n";
  exit;
  print $query->end_html;
}

print "You were successful. Your Document ID is <b>$full_docid, version
       $version</b>.<br>
       Your entry was created with the following information: <p><hr><p>\n"; 

&PrintRevisionInfo($DocRevID);
&OtherVersionLinks($documentID,$version);

if ($MailInstalled) {
  &MailNotices($DocRevID);
}

$EndTime  = new Benchmark;
$TimeDiff = timediff($EndTime,$StartTime);
print "<p><b>Execution time: </b>",timestr($TimeDiff),"<p>\n";

&DocDBNavBar();
&DocDBFooter($DBWebMasterEmail,$DBWebMasterName);
